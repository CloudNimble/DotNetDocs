<Project Sdk="Microsoft.Build.NoTargets/3.7.0">

    <PropertyGroup>
        <TargetFramework>net8.0</TargetFramework>
        <GenerateDocumentationFile>false</GenerateDocumentationFile>
        <Description>
            MSBuild SDK for DotNetDocs projects (.docsproj) - provides a clean way to include documentation in .NET
            solutions
        </Description>

        <!-- This is an MSBuild SDK package -->
        <DevelopmentDependency>true</DevelopmentDependency>
        <PackageType>MSBuildSdk</PackageType>
        <GeneratePackageOnBuild>true</GeneratePackageOnBuild>

        <!-- Suppress warnings about SDK packages -->
        <NoWarn>$(NoWarn);NU5128;CS2008;NU1701;NU5100</NoWarn>

        <!-- Don't include assemblies in package -->
        <IncludeBuildOutput>false</IncludeBuildOutput>
        <ContentTargetFolders>.</ContentTargetFolders>
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
        
        <!-- Don't create symbols package for SDK projects -->
        <IncludeSymbols>false</IncludeSymbols>
    </PropertyGroup>

    <ItemGroup>
        <!-- Include Microsoft.Build.NoTargets for bundling its SDK files -->
        <PackageReference Include="Microsoft.Build.NoTargets"
                          Version="3.7.0"
                          PrivateAssets="all"
                          GeneratePathProperty="true" />
    </ItemGroup>

    <ItemGroup>
        <!-- Reference the tasks project to ensure it builds first -->
        <ProjectReference Include="..\CloudNimble.DotNetDocs.Sdk.Tasks\CloudNimble.DotNetDocs.Sdk.Tasks.csproj" 
                          PrivateAssets="all" />
    </ItemGroup>

    <ItemGroup>
        <!-- Pack the SDK files -->
        <None Include="Sdk\**" Pack="true" PackagePath="Sdk" />
        <None Include="build\**" Pack="true" PackagePath="build" />
    </ItemGroup>

    <!-- Copy Microsoft.Build.NoTargets SDK files during build -->
    <Target Name="CopyNoTargetsSDK" AfterTargets="Build">
        <PropertyGroup>
            <NoTargetsSourcePath>$(PkgMicrosoft_Build_NoTargets)\Sdk</NoTargetsSourcePath>
            <NoTargetsDestPath>$(MSBuildProjectDirectory)\Sdk\NoTargets</NoTargetsDestPath>
        </PropertyGroup>

        <Message Text="Copying NoTargets SDK from $(NoTargetsSourcePath) to $(NoTargetsDestPath)" Importance="high" />

        <!-- Create the directory -->
        <MakeDir Directories="$(NoTargetsDestPath)" />

        <!-- Copy the files -->
        <ItemGroup>
            <NoTargetsFiles Include="$(NoTargetsSourcePath)\**\*" />
        </ItemGroup>

        <Copy SourceFiles="@(NoTargetsFiles)"
              DestinationFiles="@(NoTargetsFiles->'$(NoTargetsDestPath)\%(RecursiveDir)%(Filename)%(Extension)')"
              SkipUnchangedFiles="true" />
    </Target>

    <!-- Include the NoTargets files in the package after they're copied -->
    <Target Name="IncludeNoTargetsInPackage" DependsOnTargets="CopyNoTargetsSDK" BeforeTargets="GenerateNuspec">
        <ItemGroup>
            <None Include="Sdk\NoTargets\**" Pack="true" PackagePath="Sdk\NoTargets" />
        </ItemGroup>
    </Target>


    <!-- Copy compiled tasks and dependencies to package -->
    <Target Name="CopyTasksToPackage" AfterTargets="Build" BeforeTargets="GenerateNuspec">
        <ItemGroup>
            <!-- Include task assemblies for net8.0 only (forward compatible with newer runtimes) -->
            <TaskFiles Include="..\CloudNimble.DotNetDocs.Sdk.Tasks\bin\$(Configuration)\net8.0\*.dll" />
        </ItemGroup>
        
        <Message Text="Including task assemblies in package for net8.0 (forward compatible)" Importance="high" />
        
        <ItemGroup>
            <None Include="..\CloudNimble.DotNetDocs.Sdk.Tasks\bin\$(Configuration)\net8.0\*.dll" Pack="true" PackagePath="tasks/net8.0" />
        </ItemGroup>
    </Target>

</Project>